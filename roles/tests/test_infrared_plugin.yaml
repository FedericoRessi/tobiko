---

- hosts: primary
  vars:
    test_src_dir: /vagrant
    test_collect_dir: '{{ test_src_dir }}/test_results'
  roles:
    - tobiko-ensure-tox
    - tobiko-ensure-git
    - tobiko-ensure-rsync

  tasks:
    - name: "remove '{{ test_collect_dir }}' dir"
      file:
        path: '{{ test_collect_dir }}'
        state: absent

    - name: "run Tox InfraRed plugin"
      command:
        cmd: >
          '{{ tox_executable }}' -e infrared --
            --host secondary
            --collect-dir '{{ test_collect_dir }}'
        chdir: /vagrant
      environment:
          UPPER_CONSTRAINTS_FILE: '{{ remote_constraints_file }}'
      ignore_errors: yes
      register: run_tox

    - name: "show Tox InfraRed plugin output"
      debug: var=run_tox.stdout_lines

    - name: "show Tox InfraRed plugin errors"
      debug: var=run_tox.stderr_lines
      when: run_tox is failed
      failed_when: yes


- hosts: primary
  vars:
    test_src_dir: /vagrant
    test_collect_dir: '{{ test_src_dir }}/test_results'
  roles:
    - tobiko-check-collected-files
